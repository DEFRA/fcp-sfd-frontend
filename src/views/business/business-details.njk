{% extends 'common/layout.njk' %}

{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "common/sub-header/macro.njk" import subHeader %}
{% from "common/navigation/back-sign-out-link.njk" import appBackSignOutLink with context %}

{% block beforeContent %}
  {{ subHeader(businessName=businessNameHeader, sbi=sbi, userName=userName) }}
  {{ appBackSignOutLink(backLink) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
      {# Notification banner #}
      {% if notification %}
        {% if notification.html %}
          {{ govukNotificationBanner({
            type: "success",
            titleText: notification.title,
            html: notification.html
          })}}
        {% else %}
          {{ govukNotificationBanner({
            type: "success",
            titleText: notification.title,
            text: notification.text
          })}}
        {% endif %}
      {% endif %}

    <h1 class="govuk-heading-l">
      {{ pageTitle }}
    </h1>

    <p class="govuk-body">
      {{permissionsText}}
    </p>

    {% set formattedAddress %}
      {% for addressLine in businessAddress.value %}
        <div>{{addressLine}}</div>
      {% endfor %}
    {% endset %}

    {% set formattedCph %}
      {% for cphNumber in countyParishHoldingNumbers %}
        <div> {{cphNumber}} </div>
      {% endfor %}
    {% endset %}

    {% set displayBusinessTelephone %}
      <div>
        Telephone:
        {% if businessTelephone.telephone === 'Not added' %}
          <span class="govuk-hint display-inline">{{ businessTelephone.telephone }}</span>
        {% else %}
          <span>{{ businessTelephone.telephone }}</span>
        {% endif %}
      </div>
      <div>
        Mobile:
        {% if businessTelephone.mobile === 'Not added' %}
          <span class="govuk-hint display-inline">{{ businessTelephone.mobile }}</span>
        {% else %}
          <span>{{ businessTelephone.mobile }}</span>
        {% endif %}
      </div>
    {% endset %}

    {% set displayVatNumber %}
      {% if vatNumber.value === 'No number added' %}
        <span class="govuk-hint display-inline">{{ vatNumber.value }}</span>
      {% else %}
        <span>{{ vatNumber.value }}</span>
      {% endif %}
    {% endset %}


    <h2 class="govuk-heading-m">
      Business contact details
    </h2>

    {# Set change links #}
    {% if businessName.changeLink %}
      {% set businessNameActions = {
        items: [
          {
            href: businessName.changeLink,
            text: businessName.action,
            visuallyHiddenText: "Business name",
            classes: "govuk-link--no-visited-state"
          }
        ]
      } %}
    {% else %}
      {% set businessNameActions = null %}
    {% endif %}

    {% if businessAddress.changeLink %}
      {% set businessAddressActions = {
        items: [
          {
            href: businessAddress.changeLink,
            text: businessAddress.action,
            visuallyHiddenText: "Business address",
            classes: "govuk-link--no-visited-state"
          }
        ]
      } %}
    {% else %}
      {% set businessAddressActions = null %}
    {% endif %}

    {% if businessTelephone.changeLink %}
      {% set businessTelephoneActions = {
        items: [
          {
            href: businessTelephone.changeLink,
            text: businessTelephone.action,
            visuallyHiddenText: "Business telephone numbers",
            classes: "govuk-link--no-visited-state"
          }
        ]
      } %}
    {% else %}
      {% set businessTelephoneActions = null %}
    {% endif %}

    {% if businessEmail.changeLink %}
      {% set businessEmailActions = {
        items: [
          {
            href: businessEmail.changeLink,
            text: businessEmail.action,
            visuallyHiddenText: "Business email address",
            classes: "govuk-link--no-visited-state"
          }
        ]
      } %}
    {% else %}
      {% set businessEmailActions = null %}
    {% endif %}

    {% if vatNumber.changeLink %}
      {% if vatNumber.changeLink.items %}
        {# Already an items array (Change + Remove) #}
        {% set vatNumberActions = vatNumber.changeLink %}
      {% else %}
        {# Single link #}
        {% set vatNumberActions = {
          items: [
            {
              href: vatNumber.changeLink,
              text: vatNumber.action,
              visuallyHiddenText: "VAT registration number",
              classes: "govuk-link--no-visited-state"
            }
          ]
        } %}
      {% endif %}
    {% else %}
      {% set vatNumberActions = null %}
    {% endif %}

    {{ govukSummaryList({
      rows: [
        {
          key: {
            text: "Business name"
          },
          value: {
            text: businessName.value
          },
          actions: businessNameActions
        },
        {
          key: {
            text: "Business address"
          },
          value: {
            html: formattedAddress
          },
          actions: businessAddressActions
        },
        {
          key: {
            text: "Business phone numbers"
          },
          value: {
            html: displayBusinessTelephone
          },
          actions: businessTelephoneActions
        },
        {
          key: {
            text: "Business email address"
          },
          value: {
            text: businessEmail.value
          },
          actions: businessEmailActions
        }
      ]
    }) }}

    <h2 class="govuk-heading-m">
      Reference numbers
    </h2>

    {# For styling reasons the first row in the summary list (SBI) needs to have the actions and items property
    initialised. This allows the VAT actions to format correctly. Without it the remove and change link wrap onto new
    lines #}

      {% set referenceRows = [
        {
          key: { text: "Single business identifier (SBI)" },
          value: { text: sbi },
          actions: { items: [] }
        },
        {
          key: { text: "VAT registration number" },
          value: { html: displayVatNumber },
          actions: vatNumberActions
        }
      ]%}

      {% if tradeNumber and tradeNumber | length %}
        {% set _ = referenceRows.push({
            key: { text: "Trader number"},
            value: { html: tradeNumber }
          })
        %}
      {% endif %}

      {% if vendorRegistrationNumber and vendorRegistrationNumber | length %}
        {% set _ = referenceRows.push({
            key: { text: "Vendor registration number" },
            value: { html: vendorRegistrationNumber }
          })
        %}
      {% endif %}

      {% if countyParishHoldingNumbers and countyParishHoldingNumbers | length %}
        {% set _ = referenceRows.push({
            key: { text: countyParishHoldingNumbersText },
            value: { html: formattedCph }
          })
        %}
      {% endif %}

    {{ govukSummaryList({ rows: referenceRows }) }}

    <h2 class="govuk-heading-m">
      Additional details
    </h2>

    {% set businessLegalStatusDisplay %}
      {% if businessLegalStatus.value === 'Not added' %}
        <span class="govuk-hint display-inline">{{ businessLegalStatus.value }}</span>
      {% else %}
        <span>{{ businessLegalStatus.value }}</span>
      {% endif %}
    {% endset %}

    {% set businessTypeDisplay %}
      {% if businessType.value === 'Not added' %}
        <span class="govuk-hint display-inline">{{ businessType.value }}</span>
      {% else %}
        <span>{{ businessType.value }}</span>
      {% endif %}
    {% endset %}

    {% if businessLegalStatus.changeLink %}
      {% set businessLegalStatusActions = {
        items: [
          {
            href: businessLegalStatus.changeLink,
            text: businessLegalStatus.action,
            visuallyHiddenText: "Business legal status",
            classes: "govuk-link--no-visited-state"
          }
        ]
      } %}
    {% else %}
      {% set businessLegalStatusActions = null %}
    {% endif %}

    {% if businessType.changeLink %}
      {% set businessTypeActions = {
        items: [
          {
            href: businessType.changeLink,
            text: businessType.action,
            visuallyHiddenText: "Business type",
            classes: "govuk-link--no-visited-state"
          }
        ]
      } %}
    {% else %}
      {% set businessTypeActions = null %}
    {% endif %}

    {{ govukSummaryList({
      rows: [
        {
          key: {
            text: "Business legal status"
          },
          value: {
            html: businessLegalStatusDisplay
          },
          actions: businessLegalStatusActions
        },
        {
          key: {
            text: "Business type"
          },
          value: {
            html: businessTypeDisplay
          },
          actions: businessTypeActions
        }
      ]
    }) }}
  </div>
</div>
{% endblock %}
